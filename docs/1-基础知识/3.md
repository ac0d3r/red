# Mach-O æ–‡ä»¶æ ¼å¼

`Mach-O`æ˜¯`Mach object file format`çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§ç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ã€ç›®æ ‡ä»£ç ã€å…±äº«åº“ã€åŠ¨æ€åŠ è½½ä»£ç å’Œæ ¸å¿ƒè½¬å‚¨çš„æ–‡ä»¶æ ¼å¼ã€‚Mach-O è¢«ä¸€äº›åŸºäºMach å†…æ ¸çš„ç³»ç»Ÿä½¿ç”¨ï¼Œæ¯”å¦‚NeXTSTEPã€macOSå’ŒiOSã€‚

## åˆ†æå·¥å…·

å·´æ–¯å¸¸ç”¨æŸ¥çœ‹ MachO æ–‡ä»¶æ ¼å¼å·¥å…·æ˜¯ï¼š[MachOView](https://github.com/gdbinit/MachOView)å¯è§†åŒ–å·¥å…·å’Œ otool å‘½ä»¤è¡Œå·¥å…·ã€‚

**otool å‘½ä»¤å¤‡å¿˜å½•ğŸ“•ï¼š**
```bash
$ otool -fv file                	# æ‰“å° fat å¤´ä¿¡æ¯
$ otool -hv file                	# æ‰“å° macho å¤´ä¿¡æ¯
$ otool -lv file                	# æ‰“å°åŠ è½½å‘½ä»¤(Load Commands)ä¿¡æ¯
$ otool -Lv file               		# æ‰“å°ä½¿ç”¨çš„å…±äº«åº“
$ otool -V file -s __TEXT __text	# æ‰“å°å¯¹åº”çš„sectionå†…å®¹
```

ä½¿ç”¨ `MachOView.App` æ›´åŠ ç›´è§‚ï¼Œæ‰“å¼€ `Calculator` ï¼š

![](../assets//images/Calculator-MachOView.jpg)

## Fat Binary

é€šç”¨äºŒè¿›åˆ¶æ ¼å¼åˆç§°èƒ–äºŒè¿›åˆ¶æ ¼å¼ï¼ˆFat Binaryï¼‰ï¼Œæ˜¯å°†å¤šä¸ª Mach-O æ–‡ä»¶ç»„åˆæˆä¸€ä¸ªå¤šé‡æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚éšç€Apple Siliconçš„æ™®åŠå†…ç½®æ‰§è¡Œæ–‡ä»¶åŸºæœ¬éƒ½å˜æˆFat Binaryï¼š

```bash
$ file /usr/bin/otool
/usr/bin/otool: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64
- Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e
- Mach-O 64-bit executable arm64e]
/usr/bin/otool (for architecture x86_64):	Mach-O 64-bit executable x86_64
/usr/bin/otool (for architecture arm64e):	Mach-O 64-bit executable arm64e
```

ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…· lipo æ¥æ“ä½œé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å®ƒå¯ä»¥æ·»åŠ ã€æå–ã€åˆ é™¤ä»¥åŠæ›¿æ¢é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ç‰¹å®šæ¶æ„çš„äºŒè¿›åˆ¶ç‰ˆæœ¬ã€‚ç›´æ¥ç˜¦èº«ä¸ºæŸç§æ¶æ„çš„ç‰ˆæœ¬ï¼š
`$ lipo <Mach-O> -thin <æ¶æ„å> -output <è·¯å¾„>`
ä¹Ÿå¯ä»¥åˆå¹¶å¤šä¸ªæ¶æ„ï¼š
`$ lipo -create <Mach-O1> <Mach-O2> -output <è·¯å¾„>`

é€šç”¨äºŒè¿›åˆ¶çš„â€œé€šç”¨â€ä¸æ­¢é’ˆå¯¹å¯ä»¥ç›´æ¥è¿è¡Œçš„å¯æ‰§è¡Œç¨‹åºï¼Œç³»ç»Ÿä¸­çš„åŠ¨æ€åº“dylibã€é™æ€åº“.aæ–‡ä»¶ä»¥åŠæ¡†æ¶ç­‰éƒ½å¯ä»¥æ˜¯é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯¹å®ƒä»¬ä¹Ÿå¯ä»¥åŒæ ·ä½¿ç”¨lipoå‘½ä»¤æ¥è¿›è¡Œç®¡ç†ã€‚å¯åœ¨`<mach-o/fat.h>`æ–‡ä»¶ä¸­æ‰¾åˆ°é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼çš„å£°æ˜ï¼š

```c
struct fat_header {
	uint32_t	magic;		/* FAT_MAGIC or FAT_MAGIC_64 */
	uint32_t	nfat_arch;	/* number of structs that follow */
};

struct fat_arch {
	cpu_type_t	cputype;	/* cpu specifier (int) */
	cpu_subtype_t	cpusubtype;	/* machine specifier (int) */
	uint32_t	offset;		/* file offset to this object file */
	uint32_t	size;		/* size of this object file */
	uint32_t	align;		/* alignment as a power of 2 */
};
```

MachOViewæŸ¥çœ‹FatHeaer: 
![](../assets//images/fat-header.jpg)

otoolæ‰“å°FatHeaer:
```bash
$ otool -fv /System/Applications/Calculator.app/Contents/MacOS/Calculator
Fat headers
fat_magic FAT_MAGIC
nfat_arch 2
architecture x86_64
    cputype CPU_TYPE_X86_64
    cpusubtype CPU_SUBTYPE_X86_64_ALL
    capabilities 0x0
    offset 16384
    size 247904
    align 2^14 (16384)
architecture arm64e
    cputype CPU_TYPE_ARM64
    cpusubtype CPU_SUBTYPE_ARM64E
    capabilities PTR_AUTH_VERSION USERSPACE 0
    offset 278528
    size 262128
    align 2^14 (16384)
```

## MachO

Mach-Oæ–‡ä»¶ç”±å¤´(Header)ã€è£…è½½æŒ‡ä»¤(Load Commands)å’Œæ•°æ®(Section Data)ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆã€‚

![](../assets/images/macho-structure.png)

### Header
header ç»“æ„å®šä¹‰åœ¨ `<mach-o/loader.h>` æ–‡ä»¶ä¸­ï¼Œé’ˆå¯¹32ä½ä¸64ä½æ¶æ„çš„cpuï¼Œåˆ†åˆ«ä½¿ç”¨äº†`mach_header`ä¸`mach_header_64`ç»“æ„ä½“æ¥æè¿°Mach-Oå¤´éƒ¨ã€‚

```c
struct mach_header_64 {
	uint32_t	magic;		/* mach magic number identifier */
	cpu_type_t	cputype;	/* cpu specifier */
	cpu_subtype_t	cpusubtype;	/* machine specifier */
	uint32_t	filetype;	/* type of file */
	uint32_t	ncmds;		/* number of load commands */
	uint32_t	sizeofcmds;	/* the size of all the load commands */
	uint32_t	flags;		/* flags */
	uint32_t	reserved;	/* reserved */
};
```

`filetype`è¡¨ç¤ºç±»å‹ï¼Œå¸¸è§çš„æœ‰:

- `MH_OBJECT`: å¯é‡å®šå‘çš„ç›®æ ‡æ–‡ä»¶
- `MH_EXECUTE`: å¯æ‰§è¡Œæ–‡ä»¶
- `MH_DYLIB`: åŠ¨æ€ç»‘å®šçš„å…±äº«åº“æ–‡ä»¶
- â€¦

`flags`ä¸ºä¸åŒçš„æ–‡ä»¶æ ‡ç­¾çš„ç»„åˆï¼Œæ¯ä¸ªæ ‡ç­¾å ä¸€ä¸ªä½ï¼Œå¯ä»¥ç”¨ä½æˆ–æ¥è¿›è¡Œç»„åˆï¼Œå¸¸è§çš„æ ‡ç­¾æœ‰:

- `MH_NOUNDEFS`: è¯¥æ–‡ä»¶æ²¡æœ‰æœªå®šä¹‰çš„å¼•ç”¨
- `MH_DYLDLINK`: è¯¥æ–‡ä»¶å°†è¦ä½œä¸ºåŠ¨æ€é“¾æ¥å™¨çš„è¾“å…¥ï¼Œä¸èƒ½å†è¢«é™æ€é“¾æ¥å™¨ä¿®æ”¹
- `MH_TWOLEVEL`: è¯¥æ–‡ä»¶ä½¿ç”¨ä¸¤çº§åå­—ç©ºé—´ç»‘å®š
- `MH_PIE`: å¯æ‰§è¡Œæ–‡ä»¶ä¼šè¢«åŠ è½½åˆ°éšæœºåœ°å€(å¼€å¯aslr)ï¼Œåªå¯¹`MH_EXECUTE`æœ‰æ•ˆ

### Load Commands

åœ¨mach_headerä¹‹åçš„æ˜¯Load CommandåŠ è½½å‘½ä»¤ï¼Œè¿™äº›åŠ è½½å‘½ä»¤åœ¨Mach-Oæ–‡ä»¶åŠ è½½è§£ææ—¶ï¼Œè¢«å†…æ ¸åŠ è½½å™¨æˆ–è€…åŠ¨æ€é“¾æ¥å™¨è°ƒç”¨ï¼Œ`LOAD_COMMAND` æ˜¯ä½“ç°MachOæ–‡ä»¶æ‹“å±•æ€§çš„åœ°æ–¹ï¼Œæ¯ä¸ª command çš„å¤´ä¸¤ä¸ª word åˆ†åˆ«è¡¨ç¤ºç±»å‹å’Œå¤§å°ï¼Œå¦‚ä¸‹:
```c
struct load_command {
	uint32_t cmd;		/* type of load command */
	uint32_t cmdsize;	/* total size of command in bytes */
};
```
- cmd å­—æ®µä»£è¡¨å½“å‰åŠ è½½å‘½ä»¤çš„ç±»å‹
- cmdsize å­—æ®µä»£è¡¨å½“å‰åŠ è½½å‘½ä»¤çš„å¤§å°

ä¸åŒçš„cmdç±»å‹éƒ½ä¼šæœ‰å…¶å¯¹åº”çš„ç»“æ„ä½“æ¥æè¿°å…¶å†…å®¹ï¼Œcmdsizeè¡¨ç¤ºçš„æ˜¯æ•´ä¸ªcmdçš„å¤§å°ï¼Œå³åŒ…æ‹¬å¤´éƒ¨å’Œå†…å®¹ã€‚ä¸‹ä¸ª`command`åç§»é‡ä¸ºï¼šå½“å‰cmdçš„åç§»é‡ + cmdsizeã€‚

![](../assets/images/load-command-size.jpg)

åŠ è½½å‘½ä»¤ç±»å‹çš„å®šä¹‰åœ¨ `<mach-o/loader.h>` ä¸­ï¼Œä»¥ `LC_` ä¸ºå‰ç¼€çš„ï¼›æ‰€æœ‰çš„è¿™äº›åŠ è½½å‘½ä»¤ç”±ç³»ç»Ÿå†…æ ¸åŠ è½½å™¨ç›´æ¥ä½¿ç”¨ï¼Œæˆ–ç”±åŠ¨æ€é“¾æ¥å™¨å¤„ç†ã€‚å…¶ä¸­å‡ ä¸ªå¸¸è§çš„åŠ è½½å‘½ä»¤æœ‰`LC_SEGMENT`ã€`LC_LOAD_DYLINKER`ã€`LC_LOAD_DYLIB`ã€`LC_MAIN`ã€`LC_CODE_SIGNATURE`ã€`LC_ENCRYPTION_INFO` ç­‰ã€‚


åç§°                  | å«ä¹‰
----------------------|-----------------------------
LC_SEGMENT_64         | å°†æ–‡ä»¶ä¸­ï¼ˆ32ä½æˆ–64ä½ï¼‰çš„æ®µæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­
LC_DYLD_INFO_ONLY     | åŠ¨æ€é“¾æ¥ç›¸å…³ä¿¡æ¯
LC_SYMTAB             | ç¬¦å·åœ°å€
LC_DYSYMTAB           | åŠ¨æ€ç¬¦å·è¡¨åœ°å€
LC_LOAD_DYLINKER      | ä½¿ç”¨è°åŠ è½½ï¼Œæˆ‘ä»¬ä½¿ç”¨dyldLC_UUIDæ–‡ä»¶çš„UUID
LC_VERSION_MIN_MACOSX | æ”¯æŒæœ€ä½çš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬
LC_SOURCE_VERSION     | æºä»£ç ç‰ˆæœ¬
LC_MAIN               | è®¾ç½®ç¨‹åºä¸»çº¿ç¨‹çš„å…¥å£åœ°å€å’Œæ ˆå¤§å°
LC_LOAD_DYLIB         | ä¾èµ–åº“çš„è·¯å¾„ï¼ŒåŒ…å«ä¸‰æ–¹åº“
LC_FUNCTION_STARTS    | å‡½æ•°èµ·å§‹åœ°å€è¡¨
LC_ENCRYPTION_INFO    | åŠ å¯†çš„MachOçš„æ ‡è®°
LC_CODE_SIGNATURE     | ä»£ç ç­¾å



### Section Data
> è¿™é‡Œç®€å•äº†è§£ä¸‹

Segment å¯ä»¥ç†è§£ä¸ºä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ‹¥æœ‰å¯¹åº”çš„è¯»/å†™/æ‰§è¡Œæƒé™ã€‚ä»é€»è¾‘è§’åº¦æ¥çœ‹ï¼Œæ¯ä¸ªæ®µå†…çš„èŠ‚å­˜å‚¨çš„æ•°æ®éƒ½æœ‰ç±»ä¼¼çš„ç›®çš„ã€‚å¦‚`__TEXT` æ®µå†…å­˜å‚¨çš„æœ‰æ±‡ç¼–æºä»£ç ã€å­—ç¬¦ä¸²ç­‰ï¼Œ`__DATA` æ®µå†…å­˜å‚¨éå¸¸é‡åˆå§‹åŒ–å˜é‡ç­‰ã€‚ä»å†…å­˜ç®¡ç†è§’åº¦æ¥çœ‹ï¼Œæ¯ä¸ªæ®µçš„å¤§å°è¢«è¦æ±‚æ˜¯é¡µå¤§å°çš„å€æ•°ï¼Œä¹Ÿå°±æ˜¯ 4096B çš„å€æ•°ã€‚å½“ç¨‹åºåŠ è½½æ—¶ï¼Œå°±å¯ä»¥æ­£å¥½å°†ä¸€ä¸ªæ®µåŠ è½½åˆ°ä¸€ä¸ªé¡µå†…ã€‚æ¯ä¸ªSegmentç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªSectionç»„æˆï¼ŒSectionè¡¨ç¤ºç‰¹å®šå«ä¹‰æ•°æ®æˆ–è€…ä»£ç çš„é›†åˆ(ä¸éœ€è¦é¡µå¯¹é½)ã€‚åœ¨macOSä¸­ï¼Œé€šå¸¸çº¦å®šsegmentçš„åç§°ä¸ºåŒä¸‹åˆ’çº¿åŠ å…¨å¤§å†™å­—æ¯(å¦‚`__TEXT`)ï¼Œsectionçš„åç§°ä¸ºåŒä¸‹åˆ’çº¿åŠ å°å†™å­—æ¯(å¦‚`__text`)ã€‚

### åŠ è½½è¿‡ç¨‹
> æ€»ç»“ç½‘ä¸Šçš„èµ„æ–™

1. å†…æ ¸ç©ºé—´
	(å†…æ ¸ç©ºé—´çš„ä¸»è¦ä»»åŠ¡æ˜¯åˆ›å»ºæ–° task å¹¶åˆå§‹åŒ–å†…å­˜é¡µå’Œå¯¹åº”çš„æƒé™ï¼š
	- åˆ†é…è™šæ‹Ÿå†…å­˜ç©ºé—´ã€‚
	- fork è¿›ç¨‹ã€‚
	- åŠ è½½ MachO åˆ°è¿›ç¨‹ç©ºé—´ã€‚
	- åŠ è½½åŠ¨æ€é“¾æ¥å™¨ dyld å¹¶å°†æ§åˆ¶æƒäº¤ç»™ dyld å¤„ç†ã€‚
2. ç”¨æˆ·ç©ºé—´
	(ä»å†…æ ¸å›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾¿è·³è½¬åˆ°ç›®æ ‡çš„å…¥å£åœ°å€å¼€å§‹æ‰§è¡ŒåŠ¨æ€é“¾æ¥é˜¶æ®µï¼Œè¿›å…¥ dyld åŠ¨æ€é“¾æ¥å™¨ï¼š
	- é…ç½®ç¯å¢ƒå˜é‡
	- åŠ è½½å…±äº«ç¼“å­˜åº“
	- å®ä¾‹åŒ–ä¸»ç¨‹åº
	- åŠ è½½åŠ¨æ€é“¾æ¥åº“
	- é“¾æ¥ä¸»ç¨‹åº
	- åŠ è½½Loadå’Œç‰¹å®šçš„C++çš„æ„é€ å‡½æ•°æ–¹æ³•
	- å¯»æ‰¾APPçš„mainå‡½æ•°å¹¶è°ƒç”¨

## å‚è€ƒé“¾æ¥
- [wiki/Mach-O](https://en.wikipedia.org/wiki/Mach-O)
- [æ·±å…¥æµ…å‡ºMachO](https://evilpan.com/2020/09/06/macho-inside-out/)
- [apple/BundleTypes](https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/BundleTypes/BundleTypes.html#//apple_ref/doc/uid/10000123i-CH101-SW1)
- [iOSé€†å‘(5)-ä¸çŸ¥MachOæ€æ•¢è¯´è‡ªå·±æ‡‚DYLD](https://juejin.cn/post/6844903798717022222)