# macOSå®‰å…¨æœºåˆ¶

## å®‰å…¨æ€§æ¦‚è¿°
åœ¨[macOSçš„å®‰å…¨æ€§æ¦‚è¿°](https://www.apple.com.cn/business/docs/resources/macOS_Security_Overview.pdf)ä¸­ï¼ŒmacOSçš„å®‰å…¨æ€§ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š

![](../assets/images/macOSçš„å®‰å…¨æ€§.png)

æœ€æ–°çš„æ¦‚è¿°å¯ä»¥ç¿»é˜…ï¼š[Apple å¹³å°å®‰å…¨ä¿æŠ¤](https://support.apple.com/zh-cn/guide/security/welcome/web)ï¼Œæ”¹åŠ¨å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œå·´æ–¯è¿™é‡Œå°†çº¢é˜Ÿå…³æ³¨çš„ç‚¹é‡æ–°ç½—åˆ—æ•´ç†ã€‚

## ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤SIP

ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤æ˜¯ä¸€é¡¹å®‰å…¨æŠ€æœ¯ï¼Œæ—¨åœ¨ååŠ©é˜²æ­¢æ½œåœ¨æ¶æ„è½¯ä»¶ä¿®æ”¹ Mac ä¸Šå—ä¿æŠ¤çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤å¯ä»¥é™åˆ¶ root ç”¨æˆ·å¸æˆ·ï¼Œä»¥åŠ root ç”¨æˆ·èƒ½å¤Ÿåœ¨ Mac æ“ä½œç³»ç»Ÿçš„å—ä¿æŠ¤éƒ¨åˆ†æ‰§è¡Œçš„æ“ä½œã€‚

åœ¨å°šæœªé‡‡ç”¨ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤ï¼ˆåœ¨ OS X El Capitan(10.11) ä¸­å¼€å§‹å¼•å…¥ï¼‰ä¹‹å‰ï¼Œroot ç”¨æˆ·æ²¡æœ‰ä»»ä½•æƒé™é™åˆ¶ï¼Œå› æ­¤å®ƒå¯ä»¥è®¿é—® Mac ä¸Šçš„ä»»ä½•ç³»ç»Ÿæ–‡ä»¶å¤¹æˆ– Appã€‚å¦‚æœä½ åœ¨å®‰è£…è½¯ä»¶æ—¶è¾“å…¥äº†ç®¡ç†å‘˜ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿™ä¸ªè½¯ä»¶å°±èƒ½è·å¾— root çº§è®¿é—®æƒé™ã€‚è¿™æ ·ä½¿è½¯ä»¶èƒ½å¤Ÿä¿®æ”¹æˆ–è¦†ç›–ä»»æ„ç³»ç»Ÿæ–‡ä»¶æˆ– Appã€‚

ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤åŒ…å«å¯¹ä»¥ä¸‹ç³»ç»Ÿéƒ¨åˆ†çš„ä¿æŠ¤ï¼š

- /System
- /usr
- /bin
- /sbin
- /var
- ç³»ç»Ÿé¢„è£…çš„App

ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºå’Œå®‰è£…ç¨‹åºå¯ä»¥é’ˆå¯¹ä»¥ä¸‹è·¯å¾„å’Œ App ç»§ç»­å®Œæˆå†™å…¥æ“ä½œï¼š

- /Applications
- /Library
- /usr/local

ä»…å½“è¿›ç¨‹æ‹¥æœ‰ Apple ç­¾åå¹¶æ‹¥æœ‰å¯¹ç³»ç»Ÿæ–‡ä»¶ï¼ˆå¦‚ Apple è½¯ä»¶æ›´æ–°å’Œ Apple å®‰è£…ç¨‹åºï¼‰å®Œæˆå†™å…¥æ“ä½œçš„ç‰¹æ®Šæˆæƒæ—¶ï¼Œç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤æ‰ä¼šå…è®¸å®ƒä¿®æ”¹è¿™äº›å—ä¿æŠ¤éƒ¨åˆ†ã€‚ä» App Store ä¸‹è½½çš„ App å…¼å®¹ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤ã€‚å‡çº§è‡³ OS X El Capitan(10.11)æˆ–æ›´é«˜ç‰ˆæœ¬æ—¶ï¼Œä¸ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤å†²çªçš„å…¶ä»–ç¬¬ä¸‰æ–¹è½¯ä»¶å¯èƒ½ä¼šè¢«å¿½ç•¥ã€‚

### å…³é—­/å¼€å¯SIP
> https://appstorrent.ru/510-sip.html

å‘½ä»¤å¤‡å¿˜å½•ğŸ“•ï¼š
```bash
$ csrutil enable                # å¯ç”¨SIP
$ csrutil disable               # åœç”¨SIP
$ csrutil enable --without fs   # ä»…ç¦ç”¨æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸ä¼šå½±å“å…§æ ¸æ‰©å±•æˆ–å¹²æ‰°NVRAM
$ csrutil status                # æŸ¥çœ‹SIPå¼€å¯çŠ¶æ€
```

## Gatekeeper
Gatekeeperå®‰å…¨æŠ€æœ¯ï¼Œå…¶è®¾è®¡æ—¨åœ¨å¸®åŠ©ç¡®ä¿ä»…å—ä¿¡ä»»çš„è½¯ä»¶å¯åœ¨ç”¨æˆ·çš„ Mac ä¸Šè¿è¡Œã€‚å½“ç”¨æˆ·ä» `App Store` ä¹‹å¤–çš„åœ°æ–¹ä¸‹è½½å¹¶æ‰“å¼€ Appã€æ’ä»¶æˆ–å®‰è£…è½¯ä»¶åŒ…æ—¶ï¼ŒGatekeeperä¼šéªŒè¯è¯¥è½¯ä»¶æ˜¯å¦æ¥è‡ªå¯è¯†åˆ«çš„å¼€å‘è€…ã€ç»è¿‡ Apple å…¬è¯ä¸å«å·²çŸ¥çš„æ¶æ„å†…å®¹ä¸”æœªè¢«ä¿®æ”¹ã€‚åœ¨é¦–æ¬¡æ‰“å¼€ä¸‹è½½çš„è½¯ä»¶ä¹‹å‰ï¼Œé—¨ç¦è¿˜ä¼šè¯·æ±‚ç”¨æˆ·æ‰¹å‡†ï¼Œä»¥ç¡®ä¿ç”¨æˆ·æ²¡æœ‰è¢«è¯±éª—è¿è¡Œä»–ä»¬è®¤ä¸ºåªæ˜¯æ•°æ®æ–‡ä»¶çš„å¯æ‰§è¡Œä»£ç ã€‚

[åœ¨ Mac ä¸Šå®‰å…¨åœ°æ‰“å¼€ App](https://support.apple.com/zh-cn/HT202491)æ–‡ç« ä¸­å¯ä»¥çœ‹åˆ° Gatekeeper å„ç§æç¤ºä½œç”¨ã€‚

### æŸ¥çœ‹&æ¸…é™¤æ–‡ä»¶éš”ç¦»æ ‡è¯†
å‘½ä»¤å¤‡å¿˜å½•ğŸ“•ï¼š
```bash
$ xattr File                            # æŸ¥çœ‹æ‰€æœ‰å±æ€§æ ‡è¯†
$ xattr -p com.apple.quarantine File    # æŸ¥çœ‹æ˜¯å¦æœ‰éš”ç¦»å±æ€§æ ‡è¯†
$ xattr -rd com.apple.quarantine File   # æ¸…é™¤æ–‡ä»¶éš”ç¦»æ ‡è¯†
$ xattr -rc File                        # æ¸…é™¤æ–‡ä»¶éš”ç¦»æ ‡è¯†
```
### Gatekeeper Bypass

#### CVE-2021â€“30657
- ç³»ç»Ÿç‰ˆæœ¬ï¼šmacOS Catalina(10.15) ï½ Big Sur(11.3)
- æ–‡ç« ï¼šhttps://cedowens.medium.com/macos-gatekeeper-bypass-2021-edition-5256a2955508
- æ¼æ´æ ¹å› å‰–ææ–‡ç« ï¼šhttps://objective-see.org/blog/blog_0x64.html

æ­¤æ¼æ´åˆ©ç”¨Bashè„šæœ¬æ›¿æ¢`Some.App/Contents/MacOS/`Bundleä¸­ä¹‹å‰ macho æ–‡ä»¶ç»•è¿‡ Gatekeeper æ£€æµ‹ã€‚

## XPortect
macOS å†…å»ºäº†ç§°ä¸º XProtect çš„é˜²ç—…æ¯’æŠ€æœ¯ï¼Œå¯åŸºäºç­¾åæ£€æµ‹å’Œç§»é™¤æ¶æ„è½¯ä»¶ã€‚ç³»ç»Ÿä½¿ç”¨ç”± Apple å®šæœŸæ›´æ–°çš„ YARA ç­¾åï¼ŒYARA æ˜¯ä¸€æ¬¾ç”¨æ¥åŸºäºç­¾åæ£€æµ‹æ¶æ„è½¯ä»¶çš„å·¥å…·ã€‚Apple ä¼šç›‘è§†æ–°çš„æ¶æ„è½¯ä»¶æ„ŸæŸ“å’Œå¨èƒï¼Œå¹¶è‡ªåŠ¨æ›´æ–°ç­¾åï¼ˆç‹¬ç«‹äºç³»ç»Ÿæ›´æ–°ï¼‰ï¼Œä»¥ä¿æŠ¤ Mac å…å—æ¶æ„è½¯ä»¶ä¾µå®³ã€‚XProtect ä¼šè‡ªåŠ¨æ£€æµ‹å·²çŸ¥æ¶æ„è½¯ä»¶å¹¶é˜»æ­¢å…¶æ‰§è¡Œã€‚åœ¨ macOS 10.15 æˆ–æ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒXProtect ä¼šåœ¨ä»¥ä¸‹æ“ä½œæ‰§è¡Œæ—¶æ£€æŸ¥æ˜¯å¦å«å·²çŸ¥çš„æ¶æ„å†…å®¹ï¼š

- App é¦–æ¬¡å¯åŠ¨
- App å‘ç”Ÿæ›´æ”¹ï¼ˆåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼‰
- XProtect ç­¾åå‘ç”Ÿæ›´æ–°

XProtect æ£€æµ‹åˆ°å·²çŸ¥çš„æ¶æ„è½¯ä»¶æ—¶ï¼Œä¼šé˜»æ­¢è½¯ä»¶å¹¶é€šçŸ¥ç”¨æˆ·ï¼Œè¿˜æä¾›å°†è½¯ä»¶ç§»åˆ°åºŸçº¸ç¯“çš„é€‰é¡¹ã€‚

>ã€æ³¨ã€‘å…¬è¯å¯¹å·²çŸ¥æ–‡ä»¶ï¼ˆæˆ–æ–‡ä»¶å“ˆå¸Œï¼‰æœ‰æ•ˆï¼Œå¹¶å¯ç”¨åœ¨ä¹‹å‰å¯åŠ¨è¿‡çš„ App ä¸Šã€‚XProtect åŸºäºç­¾åçš„è§„åˆ™æ¯”ç‰¹å®šæ–‡ä»¶å“ˆå¸Œæ›´ä¸ºé€šç”¨ï¼Œå› æ­¤å®ƒå¯ä»¥æ‰¾åˆ° Apple æœªå‘ç°è¿‡çš„å˜ä½“ã€‚XProtect åªæ‰«æå‘ç”Ÿæ›´æ”¹æˆ–é¦–æ¬¡å¯åŠ¨çš„ Appã€‚

å¦‚æœæ¶æ„è½¯ä»¶å·²ä¾µå…¥ Macï¼ŒXProtect è¿˜åŒ…å«ä¿®å¤æ„ŸæŸ“çš„æŠ€æœ¯ã€‚ä¾‹å¦‚ï¼Œå®ƒåŒ…æ‹¬çš„å¼•æ“å¯åŸºäº Apple è‡ªåŠ¨å‘å¸ƒçš„æ›´æ–°ï¼ˆä½œä¸ºç³»ç»Ÿæ•°æ®æ–‡ä»¶è‡ªåŠ¨æ›´æ–°å’Œå®‰å…¨æ€§æ›´æ–°çš„ä¸€éƒ¨åˆ†ï¼‰æ¥ä¿®å¤æ„ŸæŸ“ã€‚å®ƒè¿˜ä¼šåœ¨æ”¶åˆ°æ›´æ–°ä¿¡æ¯åç«‹å³ç§»é™¤æ¶æ„è½¯ä»¶ï¼Œå¹¶ç»§ç»­å®šæœŸæ£€æŸ¥æ˜¯å¦æ„ŸæŸ“ã€‚XProtect ä¸ä¼šè‡ªåŠ¨é‡æ–°å¯åŠ¨ Macã€‚

### Yaraè§„åˆ™æå–
- `/System/Library/CoreServices/XProtect.bundle/Contents/Resources/XProtect.yara XProtect.yara`
- `/Library/Apple/System/Library/CoreServices/XProtect.bundle/Contents/Resources/XProtect.yara XProtect.yara` (on m1 or a newer version)

## ä»£ç ç­¾å
> æ‘˜è‡ª ã€ŠmacOSè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹ - 2.5.2ä»£ç ç­¾å

ä»£ç ç­¾åæ˜¯ä¸€ç§å¯¹è½¯ä»¶å®Œæ•´æ€§æ£€æŸ¥ã€è½¯ä»¶ä½œè€…èº«ä»½è¯†åˆ«çš„æŠ€æœ¯ï¼Œæ—¨åœ¨ç¡®ä¿å®ƒä»¬ä¸ä¼šè¢«ç¯¡æ”¹æˆ–ä¿®æ”¹ã€‚åœ¨ macOS 10.15 ä¸­ï¼Œä¸åœ¨ App Store ä¸­åˆ†å‘çš„æ‰€æœ‰ App å¿…é¡»ç”±å¼€å‘è€…ä½¿ç”¨ Apple ç­¾å‘çš„å¼€å‘è€… ID è¯ä¹¦ï¼ˆå’Œä¸“ç”¨å¯†é’¥ï¼‰è¿›è¡Œç­¾åå¹¶ç”± Apple å…¬è¯ï¼Œä»¥ä¾¿åœ¨é»˜è®¤çš„ "Gatekeeper" è®¾ç½®ä¸­è¿è¡Œã€‚

ä»£ç ç­¾åä½¿ç”¨ç°ä»£å¯†ç å­¦æŠ€æœ¯ï¼Œä¾èµ–äºx.509æ ‡å‡†çš„å…¬å¼€å¯†é’¥åŠ å¯†ç®—æ³•ï¼Œå¯¹è½¯ä»¶çš„ä»£ç è¿›è¡Œæ•°å­—ç­¾åã€‚macOSå¹³å°çš„è½¯ä»¶å¼€å‘è€…å‘è‹¹æœåº”ç”¨å•†åº—æäº¤çš„åº”ç”¨è½¯ä»¶éƒ½å¿…é¢†äº‹å…ˆç»è¿‡ä»£ç ç­¾åä»£ç ç­¾åéœ€è¦ç”¨åˆ°å‘è‹¹æœå…¬å¸ç”³è¯·å¼€å‘è€…èµ„æ ¼æ—¶ç”³è¯·åˆ°çš„è¯ä¹¦ã€‚è¯ä¹¦ä¸­åŒ…å«äº†ç§é’¥ã€å…¬é’¥ã€é¢å‘è€…ä»¥åŠå¼€å‘äººå‘˜çš„ä¸€äº›ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯ä½¿ç”¨KeyChainå­˜å‚¨åœ¨ macOS ç³»ç»Ÿä¸­ã€‚å¯ä»¥é€šè¿‡æ‰“å¼€ KeyChain Access æ¥æŸ¥çœ‹æœ¬æœºçš„å¼€å‘è€…è¯ä¹¦ä¿¡æ¯ã€‚ä¸‹é¢åˆ—å‡ºä¸€äº›å¸¸ç”¨å‘½ä»¤ï¼š

å‘½ä»¤å¤‡å¿˜å½•ğŸ“•ï¼š
```bash
$ security list-keychains                       # åˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰çš„keychain
$ security dump-keychain                        # è½¬å‚¨keychainä¸­çš„å†…å®¹
$ security find-identity -v -p codesigning      # æŸ¥çœ‹æœ¬æœºå¼€å‘è€…è¯ä¹¦ä¿¡æ¯
$ security find-generic-password -wa 'Chrome'   # æœç´¢é€šç”¨å¯†ç é¡¹
```

ç­¾åçš„è¿‡ç¨‹ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·codesignå®Œæˆã€‚é™¤äº†å¯¹äºŒè¿›åˆ¶åº”ç”¨è¿›è¡Œç­¾åå¤–ï¼Œcodesignè¿˜å¯ä»¥
å¯¹åŠ¨æ€åº“ã€è„šæœ¬ä»¥åŠmacosè½¯ä»¶åŒ…ä¸­çš„æ‰€æœ‰èµ„æºè¿›è¡Œç­¾åã€‚ä½¿ç”¨xcodeç¼–è¯‘ä¸€ä¸ªåº”ç”¨æ—¶ï¼Œåœ¨åº”ç”¨
æ„å»ºå®Œæˆåä¼šè‡ªåŠ¨è°ƒç”¨codesignè¿›è¡Œç­¾åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯¹åº”ç”¨è¿›è¡Œæ‰‹åŠ¨ç­¾åã€‚

å‘½ä»¤å¤‡å¿˜å½•ğŸ“•ï¼š
```bash
$ codesign -s "example ..." File                        # ç­¾å
$ codesign -f -s "example ..." File                     # é‡ç­¾å
$ codesign --options runtime -s "example ..." Foo.app   # ç­¾åå¹¶è®¾ç½®å¼ºåŒ–è¿è¡Œæ—¶
$ codesign --remove-signature File                      # ç§»é™¤ç­¾å
$ codesign -dvvv File                                   # æŸ¥çœ‹ç­¾åè¯¦ç»†ä¿¡æ¯
$ codesign -d --entitlements - File                     # æŸ¥çœ‹å·²ç­¾ååº”ç”¨æƒé™ä¿¡æ¯
$ sudo codesign --force --deep --sign - Foo.app         # å¼ºåˆ¶ç­¾å
```

### ç­¾åæƒé™

ä½¿ç”¨ `codesign` å¯¹åº”ç”¨ç­¾åæ—¶è¿˜å¯ä»¥æ·»åŠ Flagï¼Œå¦‚ä¸Š `codesign --options runtime -s "example ..." Foo.app` ç­¾åå¹¶è®¾ç½®å¼ºåŒ–è¿è¡Œæ—¶ã€‚è¿˜æœ‰ä½¿ç”¨ `ldid -e some_macho`ã€`codesign -d --entitlements - File` æŸ¥çœ‹åº”ç”¨æƒé™ä¿¡æ¯ã€‚

#### Flags
- `REQUIRE_LV`
    - éªŒè¯åŠ¨æ€åº“(require library validation)
    - `0x02000`
- `Hardened Runtime`
    - https://developer.apple.com/documentation/security/hardened_runtime
    - é˜²æ­¢æŸäº›ç±»å‹çš„æ”»å‡»ï¼ˆå¦‚ä»£ç æ³¨å…¥ã€åŠ¨æ€é“¾æ¥åº“ (DLL) åŠ«æŒå’Œè¿›ç¨‹å†…å­˜ç©ºé—´ç¯¡æ”¹ï¼‰æ¥ä¿æŠ¤è½¯ä»¶çš„è¿è¡Œæ—¶å®Œæ•´æ€§ã€‚
    - `0x10000`
- ...

#### Entitlements
- `com.apple.security.get-task-allow` å…è®¸è°ƒè¯•
- `com.apple.security.cs.allow-dyld-environment-variables` å…è®¸åŠ è½½DYLBç¯å¢ƒå˜é‡
- `com.apple.security.cs.disable-library-validation` ç¦æ­¢éªŒè¯åŠ¨æ€åº“
- ...

ä¿®æ”¹EntitlementsğŸ“•ï¼š
```bash
$ ldid -e Foo.app/Contents/MacOS/Foo >> entitlements.xml    # å¯¼å‡º entitlements.xml
$ vim entitlements.xml                                      # æ·»åŠ æƒé™
$ ldid -Sentitlements.xml Foo.app/Contents/MacOS/Foo        # é‡æ–°è®¾ç½®
```

## å‚è€ƒé“¾æ¥
- [macOSçš„å®‰å…¨æ€§](https://www.apple.com.cn/business/docs/resources/macOS_Security_Overview.pdf)
- [Apple å¹³å°å®‰å…¨ä¿æŠ¤](https://support.apple.com/zh-cn/guide/security/welcome/web)
- [å…³äºMacä¸Šçš„ç³»ç»Ÿå®Œæ•´æ€§ä¿æŠ¤](https://support.apple.com/zh-cn/HT204899)
- [appstorrent/SIP](https://appstorrent.ru/510-sip.html)
- [System Integrity Protection Guide](https://developer.apple.com/library/archive/documentation/Security/Conceptual/System_Integrity_Protection_Guide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40016462-CH1-DontLinkElementID_15)
- [macOS ä¸­çš„é—¨ç¦å’Œè¿è¡Œæ—¶ä¿æŠ¤](https://support.apple.com/zh-cn/guide/security/sec5599b66df/web)
- [åœ¨ Mac ä¸Šå®‰å…¨åœ°æ‰“å¼€ App](https://support.apple.com/zh-cn/HT202491)
- [appstorrent/Gatekeeper](https://appstorrent.ru/65-gatekeeper.html)
- [åœ¨ macOS ä¸­é˜²èŒƒæ¶æ„è½¯ä»¶](https://support.apple.com/zh-cn/guide/security/sec469d47bd8/web)
- [macOS ä¸­çš„ App ä»£ç ç­¾åè¿›ç¨‹](https://support.apple.com/zh-cn/guide/security/sec3ad8e6e53/web)
- [apple-CodeSigningGuide](https://developer.apple.com/library/archive/documentation/Security/Conceptual/CodeSigningGuide/AboutCS/AboutCS.html)
- [ã€ŠmacOSè½¯ä»¶å®‰å…¨ä¸é€†å‘åˆ†æã€‹- 2.5.2ä»£ç ç­¾å](https://book.douban.com/subject/27088100/)
- [Explainer: Keychain basics](https://eclecticlight.co/2022/10/15/explainer-keychain-basics/)